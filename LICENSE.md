Probably most of the code here belongs to Robert Nystrom. TODO: figure out license and see if it's possible to redistribute (i.e. put this on GitHub).
